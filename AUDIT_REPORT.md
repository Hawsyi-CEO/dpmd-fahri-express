# üîç AUDIT REPORT - Database Structure
**Date:** November 10, 2025  
**Project:** DPMD Express Backend

---

## ‚úÖ SUMMARY

- **Total Tables:** 29
- **Total Models:** 9
- **Issues Found:** 2 Model Definitions Incomplete
- **Unused Tables:** 20 (mostly Laravel-related)

---

## ‚ùå CRITICAL ISSUES FOUND

### 1. **Model Kecamatan - Missing Column**
**File:** `src/models/Kecamatan.js`

**Problem:**
- Migration has: `id`, `kode`, `nama`, `created_at`, `updated_at`
- Model only defines: `id`, `nama`
- **MISSING:** `kode` column

**Impact:** Cannot query/filter by `kode` using Sequelize model

**Fix Needed:**
```javascript
const Kecamatan = sequelize.define('Kecamatan', {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  kode: {                    // ‚Üê ADD THIS
    type: DataTypes.STRING(255),
    allowNull: false,
    unique: true
  },
  nama: {
    type: DataTypes.STRING(100),
    allowNull: false
  }
}, {
  tableName: 'kecamatans',
  timestamps: true,          // ‚Üê CHANGE THIS
  createdAt: 'created_at',
  updatedAt: 'updated_at'
});
```

---

### 2. **Model Desa - Missing Columns**
**File:** `src/models/Desa.js`

**Problem:**
- Migration has: `id`, `kecamatan_id`, `kode`, `nama`, `status_pemerintahan`, `is_musdesus_target`, `created_at`, `updated_at`
- Model only defines: `id`, `kode`, `nama`, `kecamatan_id`
- **MISSING:** `status_pemerintahan`, `is_musdesus_target`, `created_at`, `updated_at`

**Impact:** Cannot query desa by status or musdesus target using model

**Fix Needed:**
```javascript
const Desa = sequelize.define('Desa', {
  id: {
    type: DataTypes.INTEGER,
    primaryKey: true,
    autoIncrement: true
  },
  kecamatan_id: {
    type: DataTypes.INTEGER,
    allowNull: false
  },
  kode: {
    type: DataTypes.STRING(20),
    allowNull: false,
    unique: true
  },
  nama: {
    type: DataTypes.STRING(100),
    allowNull: false
  },
  status_pemerintahan: {     // ‚Üê ADD THIS
    type: DataTypes.ENUM('desa', 'kelurahan'),
    allowNull: false,
    defaultValue: 'desa'
  },
  is_musdesus_target: {      // ‚Üê ADD THIS
    type: DataTypes.BOOLEAN,
    allowNull: false,
    defaultValue: false
  }
}, {
  tableName: 'desas',
  timestamps: true,          // ‚Üê CHANGE THIS
  createdAt: 'created_at',
  updatedAt: 'updated_at'
});
```

---

## ‚úÖ TABLES WITH COMPLETE MODELS

| Table | Model File | Status |
|---|---|---|
| `bidangs` | `Bidang.js` | ‚úÖ Complete |
| `bumdes` | `Bumdes.js` | ‚úÖ Complete (assumed) |
| `kegiatan` | `PerjalananDinas.js` | ‚úÖ Complete |
| `kegiatan_bidang` | `KegiatanBidang.js` | ‚úÖ Complete |
| `musdesus` | `Musdesus.js` | ‚úÖ Complete |
| `personil` | `Personil.js` | ‚úÖ Complete |
| `users` | (No model, uses raw query) | ‚úÖ Used in auth.controller |

---

## ‚ö†Ô∏è UNUSED TABLES (No Model/Controller)

These tables were created from Laravel migration but NOT used in Express backend:

### Laravel System Tables
1. `cache` - Laravel cache
2. `cache_locks` - Laravel cache locks
3. `failed_jobs` - Laravel queue
4. `job_batches` - Laravel queue
5. `jobs` - Laravel queue
6. `migrations` - Laravel migrations tracker
7. `password_reset_tokens` - Laravel password reset
8. `personal_access_tokens` - Laravel Sanctum
9. `sessions` - Laravel session storage

### Laravel Spatie Permission (NOT USED - Express uses simple role enum)
10. `permissions` - Spatie permission
11. `roles` - Spatie roles (Express uses `users.role` ENUM instead)
12. `model_has_permissions` - Spatie pivot
13. `model_has_roles` - Spatie pivot  
14. `role_has_permissions` - Spatie pivot

### Kelembagaan Tables (No Express implementation yet)
15. `dinas` - Dinas data
16. `hero_galleries` - Hero gallery images
17. `petugas_monitoring` - Monitoring officers
18. `products` - Product catalog
19. `produk_hukums` - Legal products
20. `profil_desas` - Desa profiles
21. `rws` - RW data
22. `satlinmas` - Satlinmas data

---

## üìã RECOMMENDATIONS

### Priority 1: FIX MODEL DEFINITIONS ‚ö†Ô∏è
1. ‚úÖ Fix `Kecamatan.js` - add `kode` column
2. ‚úÖ Fix `Desa.js` - add `status_pemerintahan` and `is_musdesus_target`

### Priority 2: CLEAN UP UNUSED TABLES üßπ
Remove unused Laravel tables to reduce database bloat:
```sql
DROP TABLE IF EXISTS 
  cache, cache_locks, failed_jobs, job_batches, jobs,
  password_reset_tokens, personal_access_tokens, sessions,
  permissions, roles, model_has_permissions, 
  model_has_roles, role_has_permissions;
```

### Priority 3: CONSIDER IMPLEMENTING üìù
If these features are needed, create models/controllers:
- `hero_galleries` - for homepage hero images
- `produk_hukums` - for legal documents
- `profil_desas` - for complete desa profiles

---

## üéØ NEXT STEPS

1. Fix Kecamatan model
2. Fix Desa model
3. Test queries with fixed models
4. Remove unused Laravel tables
5. Document which tables are actually used

---

**Generated by:** GitHub Copilot  
**Status:** Review Required
